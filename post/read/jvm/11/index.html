<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="11.2 即时编译器 Java程序最初都是通过解释器（Interpreter）进行解释执行的，当虚拟机发现某个方法或代码块的运行特别频繁，就会把这些代"><title>第11章　后端编译与优化</title><link rel=canonical href=https://yzlc.github.io/post/read/jvm/11/><link rel=stylesheet href=/scss/style.min.abbd69b2908fdfcd5179898beaafd374514a86538d81639ddd2c58c06ae54e40.css><meta property="og:title" content="第11章　后端编译与优化"><meta property="og:description" content="11.2 即时编译器 Java程序最初都是通过解释器（Interpreter）进行解释执行的，当虚拟机发现某个方法或代码块的运行特别频繁，就会把这些代"><meta property="og:url" content="https://yzlc.github.io/post/read/jvm/11/"><meta property="og:site_name" content="YZLC"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="jvm"><meta property="article:published_time" content="2020-06-02T11:32:33+08:00"><meta property="article:modified_time" content="2023-09-25T11:15:53+08:00"><meta name=twitter:title content="第11章　后端编译与优化"><meta name=twitter:description content="11.2 即时编译器 Java程序最初都是通过解释器（Interpreter）进行解释执行的，当虚拟机发现某个方法或代码块的运行特别频繁，就会把这些代"><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-154585647-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"))</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column compact"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_huda2458f72ce188392d75c5d51cd8e24e_373_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>YZLC</a></h1><h2 class=site-description></h2></div></header><ol class=menu id=main-menu><li><a href=/tags/><span>标签</span></a></li><li><a href=/categories/><span>分类</span></a></li><li><a href=/post/web><span>网站大全</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>暗色模式</span></li></div></ol></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/read/>read</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/post/read/jvm/11/>第11章　后端编译与优化</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Jun 02, 2020</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>阅读时长: 5 分钟</time></div></footer></div></header><section class=article-content><h2 id=112即时编译器>11.2　即时编译器</h2><blockquote><p>Java程序最初都是通过解释器（Interpreter）进行解释执行的，当虚拟机发现某个方法或代码块的运行特别频繁，就会把这些代码认定为“热点代码”（Hot Spot Code），虚拟机将会把这些代码编译成本地机器码，并以各种手段尽可能地进行代码优化，运行时完成这个任务的后端编译器被称为即时编译器</p></blockquote><h3 id=1121解释器与编译器>11.2.1　解释器与编译器</h3><p>解释器</p><ul><li>省去编译的时间，立即运行</li><li>节约内存</li><li>作为编译器激进优化时后备的逃生门</li></ul><p>编译器</p><ul><li>编译成本地代码，减少解释器的中间损耗，获得更高的执行效率</li></ul><p><img src=/images/read/jvm/11-1.jpg loading=lazy></p><p>分层编译</p><ul><li>第0层。程序纯解释执行，不开启性能监控功能（Profiling）</li><li>第1层。使用客户端编译器将字节码编译为本地代码来运行，进行简单可靠的稳定优化，不开启性能监控功能</li><li>第2层。仍然使用客户端编译器执行，仅开启方法及回边次数统计等有限的性能监控功能</li><li>第3层。仍然使用客户端编译器执行，开启全部性能监控，除了第2层的统计信息外，还会收集如分支跳转、虚方法调用版本等全部的统计信息</li><li>第4层。使用服务端编译器将字节码编译为本地代码，相比起客户端编译器，服务端编译器会启用更多编译耗时更长的优化，还会根据性能监控信息进行一些不可靠的激进优化</li></ul><p><img src=/images/read/jvm/11-2.jpg loading=lazy></p><h3 id=1122编译对象与触发条件>11.2.2　编译对象与触发条件</h3><p>热点代码（编译对象都是方法）</p><ul><li>被多次调用的方法</li><li>被多次执行的循环体<ul><li>栈上替换（On Stack Replacement，OSR）： 编译时传入执行入口点字节码序号（Byte Code Index，BCI）</li></ul></li></ul><p>热点探测</p><ul><li>基于采样的热点探测（Sample Based Hot Spot Code Detection）。周期性地检查各个线程的调用栈顶，如果发现某个（或某些）方法经常出现在栈顶，那这个方法就是“热点方法”<ul><li>实现简单高效，还可以很容易地获取方法调用关系</li><li>很难精确地确认一个方法的热度，容易受到线程阻塞或别的外界因素的影响</li></ul></li><li>基于计数器的热点探测（Counter Based Hot Spot Code Detection）。为每个方法（甚至是代码块）建立计数器，统计方法的执行次数，如果执行次数超过一定的阈值就认为它是“热点方法”<ul><li>实现起来要麻烦一些，需要为每个方法建立并维护计数器，而且不能直接获取到方法的调用关系</li><li>统计结果相对来说更加精确严谨</li></ul></li></ul><p>计数器</p><ul><li>方法调用计数器（Invocation Counter）： 统计方法被调用的次数<ul><li>热度的衰减（Counter Decay）： 当超过一定的时间限度，如果方法的调用次数仍然不足以让它提交给即时编译器编译，那该方法的调用计数器就会被减少一半，这段时间就称为此方法统计的半衰周期（Counter Half Life Time）</li></ul></li><li>回边计数器（Back Edge Counter，“回边”的意思就是指在循环边界往回跳转）</li></ul><h3 id=1123编译过程>11.2.3　编译过程</h3><p>高级中间代码表示（High-Level Intermediate Representation，HIR，即与目标机器指令集无关的中间表示）。</p><p>静态单分配（Static Single Assignment，SSA）</p><p>低级中间代码表示（Low-Level IntermediateRepresentation，LIR，即与目标机器指令集相关的中间表示）</p><p><img src=/images/read/jvm/11-5.jpg loading=lazy></p><h3 id=113提前编译器>11.3　提前编译器</h3><h4 id=1131提前编译的优劣得失>11.3.1　提前编译的优劣得失</h4><h3 id=114编译器优化技术>11.4　编译器优化技术</h3><h4 id=1142方法内联>11.4.2　方法内联</h4><blockquote><p>把目标方法的代码原封不动地“复制”到发起调用的方法之中，避免发生真实的方法调用</p></blockquote><p>虚方法内联问题</p><ul><li>类型继承关系分析（Class HierarchyAnalysis，CHA）: 这是整个应用程序范围内的类型分析技术，用于确定在目前已加载的类中，某个接口是否有多于一种的实现、某个类是否存在子类、某个子类是否覆盖了父类的某个虚方法等信息<ul><li>守护内联（Guarded Inlining）: 查询到只有一个版本</li><li>内联缓存（Inline Cache）: 查询到多个版本，建立在目标方法正常入口之前的缓存,记录下方法接收者的版本信息<ul><li>单态内联缓存（Monomorphic Inline Cache）： 每次调用的方法接收者版本都是一样的</li><li>超多态内联缓存（Megamorphic Inline Cache）： 方法接收者不一致</li></ul></li></ul></li></ul><h4 id=1143逃逸分析escape-analysis>11.4.3　逃逸分析（Escape Analysis）</h4><p>基本原理</p><ul><li>方法逃逸： 当一个对象在方法里面被定义后，它可能被外部方法所引用，例如作为调用参数传递到其他方法中</li><li>线程逃逸： 被外部线程访问，譬如赋值给可以在其他线程中访问的实例变量</li></ul><p>优化</p><ul><li>栈上分配（Stack Allocations）：如果确定一个对象不会逃逸出线程之外，那让这个对象在栈上分配内存将会是一个很不错的主意，对象所占用的内存
空间就可以随栈帧出栈而销毁。支持方法逃逸，不支持线程逃逸</li><li>标量替换（Scalar Replacement）：把一个Java对象拆散，根据程序访问的情况，将其用到的成员变量恢复为原始类型来访问。它不允许对象逃逸出方法范围内。<ul><li>标量: 一个数据已经无法再分解成更小的数据来表示了（int、long等数值类型及reference类型等）</li><li>聚合量（Aggregate）: 一个数据可以继续分解(对象)</li></ul></li><li>同步消除（Synchronization Elimination）：如果确定一个变量不会逃逸出线程，无法被其他线程访问，对这个变量实施的同步措施也就可以安全地消除掉。</li></ul><h4 id=1144公共子表达式消除>11.4.4　公共子表达式消除</h4><blockquote><p>如果一个表达式E之前已经被计算过了，并且从先前的计算到现在E中所有变量的值都没有发生变化</p></blockquote><p>局部公共子表达式消除（Local Common Subexpression Elimination）: 优化仅限于程序基本块内<br>全局公共子表达式消除（Global Common Subexpression Elimination）: 优化的范围涵盖了多个基本块</p><h4 id=1145数组边界检查消除array-bounds-checking-elimination>11.4.5　数组边界检查消除（Array Bounds Checking Elimination）</h4></section><footer class=article-footer><section class=article-tags><a href=/tags/jvm/>jvm</a></section><section class=article-lastmod><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span>最后更新于 Sep 25, 2023 11:15 +0800</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/post/read/jvm/10/><div class=article-details><h2 class=article-title>第10章　前端编译与优化</h2></div></a></article><article><a href=/post/read/jvm/8/><div class=article-details><h2 class=article-title>第8章　虚拟机字节码执行引擎</h2></div></a></article><article><a href=/post/read/jvm/7/><div class=article-details><h2 class=article-title>第7章　虚拟机类加载机制</h2></div></a></article><article><a href=/post/read/jvm/6.4/><div class=article-details><h2 class=article-title>6.4　字节码指令简介</h2></div></a></article><article><a href=/post/read/jvm/6.3/><div class=article-details><h2 class=article-title>6.3　Class类文件的结构</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2023 YZLC</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.20.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>