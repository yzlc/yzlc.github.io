<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="3.7 过程 3.7.1 运行时栈 x86-64的栈向低地址方向增长，栈指针%rsp指向栈顶元素。减小栈指针分配空间，增加栈指针释放空间 当x86-64过程需要的"><title>3.7 过程</title><link rel=canonical href=https://yzlc.github.io/post/read/csapp/3.7/><link rel=stylesheet href=/scss/style.min.abbd69b2908fdfcd5179898beaafd374514a86538d81639ddd2c58c06ae54e40.css><meta property="og:title" content="3.7 过程"><meta property="og:description" content="3.7 过程 3.7.1 运行时栈 x86-64的栈向低地址方向增长，栈指针%rsp指向栈顶元素。减小栈指针分配空间，增加栈指针释放空间 当x86-64过程需要的"><meta property="og:url" content="https://yzlc.github.io/post/read/csapp/3.7/"><meta property="og:site_name" content="YZLC"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="csapp"><meta property="article:published_time" content="2019-12-31T12:32:33+08:00"><meta property="article:modified_time" content="2023-09-25T11:15:53+08:00"><meta name=twitter:title content="3.7 过程"><meta name=twitter:description content="3.7 过程 3.7.1 运行时栈 x86-64的栈向低地址方向增长，栈指针%rsp指向栈顶元素。减小栈指针分配空间，增加栈指针释放空间 当x86-64过程需要的"><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-154585647-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"))</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column compact"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_huda2458f72ce188392d75c5d51cd8e24e_373_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>YZLC</a></h1><h2 class=site-description></h2></div></header><ol class=menu id=main-menu><li><a href=/tags/><span>标签</span></a></li><li><a href=/categories/><span>分类</span></a></li><li><a href=/post/web><span>网站大全</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>暗色模式</span></li></div></ol></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/read/>read</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/post/read/csapp/3.7/>3.7 过程</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Dec 31, 2019</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>阅读时长: 3 分钟</time></div></footer></div></header><section class=article-content><h2 id=37-过程>3.7 过程</h2><h3 id=371-运行时栈>3.7.1 运行时栈</h3><ul><li>x86-64的栈向低地址方向增长，栈指针%rsp指向栈顶元素。减小栈指针分配空间，增加栈指针释放空间</li><li>当x86-64过程需要的存储空间超出寄存器存放大小，就会在栈上分配空间（栈帧）</li><li>许多函数不需要栈帧（所有局部变量都保存在寄存器，不调用其他函数）（树结构中的叶子过程）</li></ul><h3 id=372-转移控制>3.7.2 转移控制</h3><p>P->Q：call push A（P指令后的地址），PC设为Q；ret pop A，把PC设为A</p><div class=table-wrapper><table><thead><tr><th>指令</th><th>描述</th></tr></thead><tbody><tr><td>call Label</td><td>过程调用</td></tr><tr><td>call *Operand</td><td>过程调用</td></tr><tr><td>ret</td><td>从过程调用中返回</td></tr></tbody></table></div><h3 id=373-数据传送>3.7.3 数据传送</h3><p>x86-64中，寄存器最多传递6个整型参数，超过部分栈传递</p><div class=table-wrapper><table><thead><tr><th>操作数大小（位）</th><th>参数数量1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th></tr></thead><tbody><tr><td>64</td><td>%rdi</td><td>%rsi</td><td>%rdx</td><td>%rcx</td><td>%r8</td><td>%r9</td></tr><tr><td>32</td><td>%edi</td><td>%esi</td><td>%edx</td><td>%ecx</td><td>%r8d</td><td>%r9d</td></tr><tr><td>16</td><td>%di</td><td>%si</td><td>%dx</td><td>%cx</td><td>%r8w</td><td>%r9w</td></tr><tr><td>8</td><td>%dil</td><td>%sil</td><td>%dl</td><td>%cl</td><td>%r8b</td><td>%r9b</td></tr></tbody></table></div><h3 id=374-栈上的局部存储>3.7.4 栈上的局部存储</h3><ul><li>局部数据必须存放在内存的情况<ul><li>寄存器不够存放所有本地数据</li><li>对局部变量使用地址运算符‘&’，因此必须能够为它产生一个地址</li><li>某些局部变量是数组或结构，因此必须能够通过数组或结构引用被访问到</li></ul></li></ul><h3 id=375-寄存器中的局部存储空间>3.7.5 寄存器中的局部存储空间</h3><ul><li>寄存器组是唯一被所有过程共享的资源</li><li>被调用者保存寄存器：%rbx、%rbp和%r12~%r15</li><li>调用者保存寄存器：除了栈指针%rsp</li></ul><h3 id=376-递归过程>3.7.6 递归过程</h3><h2 id=38-数组分配和访问>3.8 数组分配和访问</h2><h3 id=381-基本原则>3.8.1 基本原则</h3><p>T A[N]</p><ul><li>L：T的大小（字节）</li><li>A：数组开头指针，值为$x_A$</li><li>元素i：存放在地址为$x_A+L·i$的地方</li></ul><h3 id=382-指针运算>3.8.2 指针运算</h3><ul><li>&：指针</li><li>*：间接引用指针（值）</li><li>Expr与- &amp;Expr等价</li></ul><h3 id=383-嵌套的数组>3.8.3 嵌套的数组</h3><ul><li>数组元素在内存中按照“行优先”的顺序排列</li><li>T D[R][C]<ul><li>D[i][j]的内存地址：&amp;D[i][j] = $x_D$+L(C·i+j)</li><li>L：数据类型T大小（字节）</li></ul></li></ul><h3 id=384-定长数组>3.8.4 定长数组</h3><h3 id=385-变长数组>3.8.5 变长数组</h3><h2 id=39-异质的数据结构>3.9 异质的数据结构</h2><h3 id=391-结构>3.9.1 结构</h3><h3 id=392-联合>3.9.2 联合</h3><h3 id=393-数据对齐>3.9.3 数据对齐</h3><h2 id=310-在机器级程序中将控制与数据结合起来>3.10 在机器级程序中将控制与数据结合起来</h2><h3 id=3101-理解指针>3.10.1 理解指针</h3><ul><li>每个指针都对应一个类型。例：<ul><li><code>int *ip</code>：int类型指针</li><li><code>char **cpp</code>：char*类型指针</li></ul></li><li>每个指针都有一个值(类型对象的地址)。NULL(0)值表示没指向任何地方</li><li>指针用<code>&</code>运算符创建<ul><li>lvalue：可以出现在赋值语句左边的表达式</li><li>这个运算符可以应用到lvalue类的C表达式上</li><li>机器代码常常用leaq指令(计算内存引用地址)实现</li></ul></li><li><code>*</code>操作符用于间接引用指针<ul><li>结果是一个值</li><li>用内存引用实现：要么是存储到指定地址，要么是从指定地址读取</li></ul></li><li>数组与指针紧密联系<ul><li>数组名字可以像指针变量一样引用但不能修改</li><li>数组引用(<code>a[3]</code>)与指针运算和间接引用(<code>*(a + 3)</code>)有一样的效果<ul><li>数组引用和指针运算都需要用对象大小对偏移量进行伸缩</li><li>当我们写表达式p + i,这里指针p的值为$p$,得到的地址计算为$p+L·i$，$L$是与p相关联的数据类型的大小</li></ul></li></ul></li><li>指针也可以指向函数(值是该函数机器代码表示中第一条指令的地址)<ol><li>定义函数：<br><code>int fun(int x,int *p);</code></li><li>声明指针并赋值：<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=p>(</span><span class=o>*</span><span class=n>fp</span><span class=p>)(</span><span class=kt>int</span><span class=p>,</span><span class=kt>int</span> <span class=o>*</span><span class=p>);</span><span class=c1>//括号是必须的，防止被解读成(int *) fp(int,int *);
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>fp</span> <span class=o>=</span> <span class=n>fun</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div></li><li>调用：<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=n>y</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>result</span> <span class=o>=</span> <span class=nf>fp</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span><span class=o>&amp;</span><span class=n>y</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div></li></ol></li></ul><h3 id=3102-应用使用gdb调试器>3.10.2 应用：使用GDB调试器</h3><h3 id=3103-内存越界引用和缓冲区溢出>3.10.3 内存越界引用和缓冲区溢出</h3><h3 id=3104-对抗缓冲区溢出攻击>3.10.4 对抗缓冲区溢出攻击</h3><ol><li>栈随机化</li><li>栈破坏检测</li><li>限制可执行代码区域</li></ol><h3 id=3105-支持变长栈帧>3.10.5 支持变长栈帧</h3><h2 id=311-浮点代码>3.11 浮点代码</h2></section><footer class=article-footer><section class=article-tags><a href=/tags/csapp/>csapp</a></section><section class=article-lastmod><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span>最后更新于 Sep 25, 2023 11:15 +0800</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/post/read/csapp/3.6/><div class=article-details><h2 class=article-title>3.6 控制</h2></div></a></article><article><a href=/post/read/csapp/3/><div class=article-details><h2 class=article-title>第3章 程序的机器级表示</h2></div></a></article><article><a href=/post/read/csapp/2/><div class=article-details><h2 class=article-title>第2章 信息的表示和处理</h2></div></a></article><article><a href=/post/read/csapp/1/><div class=article-details><h2 class=article-title>第1章 计算机系统漫游</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2023 YZLC</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.20.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>